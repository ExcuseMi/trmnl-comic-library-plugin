{% assign orientation = trmnl.plugin_settings.custom_fields_values.orientation | default: "portrait" %}

{%- comment -%} Check if item is an array by trying to access first element {%- endcomment -%}
{%- assign test_item = IDX_1.rss.channel.item[0] -%}
{%- if test_item -%}
  {%- comment -%} It's an array {%- endcomment -%}
  {%- assign items_with_images = IDX_1.rss.channel.item -%}
  {%- if trmnl.plugin_settings.custom_fields_values.only_show_latest != "yes" -%}
    {%- assign random_index = "now" | date: "%s" | modulo: items_with_images.size -%}
    {%- assign item = items_with_images[random_index] -%}
  {%- else -%}
    {%- assign item = items_with_images | first -%}
  {%- endif -%}
{%- else -%}
  {%- comment -%} It's a single object {%- endcomment -%}
  {%- assign item = IDX_1.rss.channel.item -%}
{%- endif -%}

<style>
  #comic {
    width: 100%;
    height: 100%;
    display: block;
    object-fit: contain;
    object-position: center;
  }
</style>

<div class="layout layout--col layout--stretch layout--center-y layout--center">
  {%- if item -%}
    <img id="comic" class="image image-dither layout--center" />
  {%- else -%}
    <div class="label layout--center">Could not find any comics.</div>
  {%- endif -%}
</div>

<div class="title_bar">
  <span class="title">{%- if item -%}{{ item.title }}{%- else -%}No comics found{%- endif -%}</span>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const imgEl = document.getElementById("comic");
    
    // Try enclosure URL first
    let enclosureUrl = `{{ item.enclosure.url | default: "" }}`;
    
    if (enclosureUrl && enclosureUrl.trim() !== '') {
      imgEl.src = enclosureUrl;
      return;
    }
    
    // Fallback: parse description HTML
    let content = `{{ item.description | escape }}`;
    
    // Unescape the content
    const textarea = document.createElement('textarea');
    textarea.innerHTML = content;
    content = textarea.value;
    
    if (content && content.trim() !== '') {
      const parser = new DOMParser();
      const parsed = parser.parseFromString(content, "text/html");
      const feedImg = parsed.querySelector("img");
      
      if (feedImg && feedImg.src) {
        imgEl.src = feedImg.src;
      }
    }
  });
</script>